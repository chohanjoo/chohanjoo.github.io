---
layout: post
title:  "앱 노출을 위해 서비스 이용하기"
date:   2019-06-18 15:00:00
tags:    [Cloud, Container, K8s]
comments: true
---
# 앱 노출을 위해 서비스 이용하기



## 쿠버네티스 서비스

워커 노드가 죽으면, 노드 상에서 동작하는 파드들 또한 종료된다.

**ReplicaSet**은 애플리케이션이 지속적으로 동작할 수 있도록 새로운 파드들의 생성을 통해 동적으로 클러스터를 미리 지정해 둔 상태로 되돌려 줄 수 있다.

쿠버네티스에서 서비스는 하나의 논리적인 set of Pods 과 그 Pods들에 접근할 수 있는 정책을 정의하는 추상적 개념이다.

서비스는 종속적인 파드들 사이를 느슨하게 결합되도록 해준다.
서비스는 모든 쿠버네티스 오브젝트들과 같이 YAML 또는 JSON을 이용하여 정의된다. 

서비스가 대상으로 하는 set of Pods은 보통 LabelSelector에 의해 결정된다.



비록 각 파드들이 고유의 IP를 갖고 있기는 하지만, 그 IP들은 서비스의 도움없이 클러스터 외부로 노출되어질 수 없다.
서비스들은 애플리케이션들에게 트래픽이 실릴 수 있도록 허용해준다.
서비스들은 ServiceSpec 에서 type을 지정함으로써 다양한 방식들로 노출시킬 수 있다.



- ClusterIP (기본값) 

  - 클러스터 내에서 내부 IP에 대해 서비스를 노출해준다.
  - 이 방식은 오직 클러스터 내에서만 서비스가 접근될 수 있도록 해준다.

- NodePort

  - NAT가 이용되는 클러스터 내에서 각각 선택된 노드들의 동일한 포트에 서비스를 노출시켜준다.
  - <NodeIP>:<NodePort> 를 이용하여 클러스터 외부로부터 서비스가 접근할 수 있도록한다.
  - CluserIP의 상위 집합

- LoadBalancer

  - 기존 클라우드에서 외부용 로드밸런서를 생성하고 서비스에 고정된 공인 IP를 할당해준다.
  - NodePort의 상위 집합

- ExternalName

  - 이름으로 CNAME 레코드를 반환함으로써 임의의 이름 (spec 에서 externalName으로 명시)을 이용하여 서비스를 노출시켜준다.

  - 프록시는 사용되지 않음

    

    ![services](/Users/hanjoo/github_blog/assets/image/k8s/services.svg)



서비스는 set of Pods에 걸쳐서 트래픽을 라우트한다.
애플리케이션에 영향을 주지 않으면서 쿠버네티스에서 Pods가 죽게도 하고, 복제가 되게도 해주는 추상적 개념이다.

종속적인 파드들 사이에서의 디스커버리와 라우팅은 (하나의 애플리케이션에서 프론트엔드와 백엔드 컴포넌트와 같은) 쿠버네티스 서비스들에 의해 처리된다.

서비스는 쿠버네티스의 객체들에 대해 논리 연산을 허용해주는 기본 그룹핑 단위인, labels 과 selectors를 이용하여 set of pods과 매치시킨다. Labels은 오브젝트들에 붙여진 키/밸류 쌍으로 다양한 방식으로 이용 가능하다.



![labels](/Users/hanjoo/github_blog/assets/image/k8s/labels.svg)

## 1. Create a new service

### 클러스터에 서비스 리스트 출력

~~~
kubectl get services
~~~



### 새로운 서비스 생성

새로운 서비스를 생성하고 외부 트래픽에 노출시키려면 NodePort와 함께 expose 명령을 매개 변수로 사용해야 한다.

~~~
kubectl expose deployment/kubernetes-bootcamp --type="NodePort" --port 8080
~~~

이제 kubernetes-bootcamp라는 실행중인 서비스가 있습니다. 
여기서는 서비스가 고유 클러스터 -IP, 내부 포트 및 외부 -IP (노드의 IP)를 수신했음을 알 수 있습니다.



###외부에서 어떤 포트가 열렸는지 확인

~~~
kubectl describe services/kubernetes-bootcamp
~~~



### 할당 된 노드 포트의 값을 갖는 NODE_PORT라는 환경 변수를 작성

~~~
export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
~~~



### 노드의 IP 및 외부에서 노출 된 포트를 사용하여 클러스터 외부에 노출되었는지 확인

~~~
curl $(minikube ip):$NODE_PORT
~~~

서버로부터 응답을 얻었다.
서비스가 노출된 것이다.



## 2. Using labels

Deployment는 Pod를 위한 label을 자동적으로 만들었다.
describe deployment 명령을 사용하면 label 이름을 볼 수 있다.

~~~
kubectl describe deployment
~~~



해당 label을 사용하여 Pods 리스트, services 리스트에 쿼리할 수 있다.

~~~
kubectl get pods -l run=kubernetes-bootcamp
~~~

~~~
kubectl get services -l run=kubernetes-bootcamp
~~~



새 label을 적용하려면 label 명령 다음에 객체 유형, 객체 이름 및 새 레이블을 사용한다.

~~~
kubectl label pod $POD_NAME app=v1
~~~

이렇게 하면 새 label이 pod에 적용된다.
describe pod 명령을 사용하여 확인할 수 있다.

~~~
kubectl describe pods $POD_NAME
~~~

~~~
kubectl get pods -l app=v1
~~~



## 3. Deleting a service

~~~
kubectl delete service -l run=kubernetes-bootcamp
~~~



### 확인

~~~
kubectl get services
~~~



이제 앱이 클러스터 외부에서 더 이상 접근할 수 없다.